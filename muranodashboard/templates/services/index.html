{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load horizon %}
{% load custom_filters %}
{% block title %}{% trans "Components" %}{% endblock %}

{% block page_header %}
  {% include "services/_page_header.html" %}
{% endblock page_header %}
{% block main %}
  <input type="hidden" id="environmentId" value="{{ environment_id }}">
<div class="row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  {{ tab_group.render }}
  </div>
</div>
{% endblock %}

{% block css %}
  {% include "_stylesheets.html" %}
  <link rel="stylesheet" href="{% static 'muranodashboard/css/catalog.css' %}"/>
{% endblock %}

{% block js %}
  {% include 'horizon/_scripts.html' %}
  <script type="text/template" id="app_tile_small">
  {% jstemplate %}
    {% url 'horizon:murano:catalog:images' '[[app_id]]' as image_url %}
    {% url 'horizon:murano:catalog:add' '[[app_id]]' '[[environment_id]]' 'True' 'True' as add_url %}
    <div class="col-xs-2 draggable_app">
      <div class="well well-sm" draggable="true">
        <img class="centering" src="{{ image_url|unquote }}"
             height="50" width="50" draggable="false"/>
        <input type="hidden" value="{{ add_url|unquote }}"/>
        <div class="centering">[[app_name]]</div>
      </div>
    </div>
  {% endjstemplate %}
  </script>
  <script>
  $(function() {
    var $dropArea = $('.drop_component'),
        draggedAppUrl = null,
        firstDropTarget = null;

    function bindAppTileHandlers() {
      $('.draggable_app').each(function () {
        $(this).on('dragstart', function (ev) {
          ev.originalEvent.dataTransfer.effectAllowed = 'copy';
          // we have to use an external variable for this since
          // storing data in dataTransfer object works only for FF
          draggedAppUrl = $(this).find('input[type="hidden"]').val();
          // set it so the DND works in FF
          ev.originalEvent.dataTransfer.setData('text/uri-list', draggedAppUrl);
        }).on('dragend', function () {
          $dropArea.removeClass('over');
        })
      });
    }

    $dropArea.on('dragover', function (ev) {
      ev.preventDefault();
      ev.originalEvent.dataTransfer.dropEffect = 'copy';
      return false;
    }).on('dragenter', function (ev) {
      $dropArea.addClass('over');
      firstDropTarget = ev.target;
    }).on('dragleave', function (ev) {
      if (firstDropTarget === ev.target) {
        $dropArea.removeClass('over');
      }
    }).on('drop', function (ev) {
      ev.preventDefault();
      horizon.modals.loadModal(draggedAppUrl);
      return false;
    });

    var packages = $.parseJSON($('#apps_carousel_contents').val());

    function subdivide(numOfItems) {
      var chunks = [],
          seq = this,
          head = seq.slice(0, numOfItems),
          tail = seq.slice(numOfItems);
      while (tail.length) {
        chunks.push(head);
        head = tail.slice(0, numOfItems);
        tail = tail.slice(numOfItems);
      }
      chunks.push(head);
      return chunks;
    }

    Array.prototype.subdivide = subdivide;

    var $carouselInner = $('.carousel-inner'),
        $carousel = $('#apps_carousel'),
        $filter = $('#envAppsFilter').find('input'),
        $noApps = $('.no_apps'),
        category = ALL_CATEGORY = 'All',
        filterValue = '',
        ENTER_KEYCODE = 13;

    var tileTemplate = Hogan.compile($('#app_tile_small').html()),
        environmentId = $('#environmentId').val();

    function fillCarousel(apps) {
      if (apps.length) {

        apps.subdivide(6).forEach(function (chunk, index) {
          var $item = $('<div class="item"></div>'),
              $row = $('<div class="row"></div>');
          if (index == 0) {
            $item.addClass('active');
          }
          $item.appendTo($row);
          chunk.forEach(function (pkg) {
            var html = tileTemplate.render({
              app_name: pkg.name,
              environment_id: environmentId,
              app_id: pkg.id
            });
            $(html).appendTo($item);
          });
          $item.appendTo($carouselInner);
        });
        $carousel.show();
        bindAppTileHandlers();
        $noApps.hide();
      } else {
        $carousel.hide();
        $noApps.show();
      }
    }

    fillCarousel(packages);

    $carousel.carousel({interval: false});

    function refillCarousel() {
      $carouselInner.empty();
      if (category === ALL_CATEGORY && filterValue === '') {
        fillCarousel(packages);
      } else {
        var filterRegexp = new RegExp(filterValue, 'i'),
            filterRegexpExact = new RegExp('\\b' + filterValue + '\\b', 'i');
        fillCarousel(packages.filter(function (pkg) {
          var categorySatisfied = true, filterSatisfied = true;
          if (category !== ALL_CATEGORY) {
            categorySatisfied = pkg.categories.indexOf(category) > -1;
          }
          if (filterValue !== '') {
            filterSatisfied = pkg.name.match(filterRegexp);
            filterSatisfied = filterSatisfied || pkg.description.match(filterRegexp);
            filterSatisfied = filterSatisfied || pkg.tags.some(function (tag) {
              return tag.match(filterRegexpExact);
            });
          }
          return categorySatisfied && filterSatisfied;
        }))
      }
    }

    // dynamic carousel refilling on category change
    $('#envAppsCategory').on('click', 'a', function (env) {
      category = $(this).text();
      $('#envAppsCategoryName').text(category);
      refillCarousel();
      env.preventDefault();
    });

    // dynamic carousel refilling on search box non-empty submission
    $filter.keypress(function (ev) {
      if (ev.which == ENTER_KEYCODE) {
        filterValue = $filter.val();
        refillCarousel();
        ev.preventDefault();
      }
    });
  });
  </script>
{% endblock %}